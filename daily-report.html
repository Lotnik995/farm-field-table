<script>
(function(){
  const reportDateEl = document.getElementById('reportDate');
  const prevBtn = document.getElementById('prevDay');
  const nextBtn = document.getElementById('nextDay');
  const screenBody = document.getElementById('screenBody');
  const printBody = document.getElementById('printBody');
  const totalsEl = document.getElementById('totals');
  const printDateLabel = document.getElementById('printDateLabel');
  const printTotals = document.getElementById('printTotals');
  const printBtn = document.getElementById('printBtn');
  const csvBtn = document.getElementById('csvBtn');

  function isoToday(){ return new Date().toISOString().slice(0,10); }
  reportDateEl.value = isoToday();

  function formatNum(n,d=0){
    if(isNaN(n)) return n;
    return Number(n).toLocaleString(undefined,{minimumFractionDigits:d, maximumFractionDigits:d});
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  }

  function renderForDate(isoDate){
    screenBody.innerHTML = '';
    printBody.innerHTML = '';
    printDateLabel.textContent = isoDate;

    const jobs = window.FarmApp.getJobsForDate(isoDate);
    if(!jobs.length){
      totalsEl.textContent = 'Totals: 0 ha → 0 kg';
      printTotals.textContent = '';
      return;
    }

    let totalHa = 0, totalKg = 0;

    jobs.forEach((j, idx)=>{
      const size = Number(j.size)||0;
      const total = Number(j.total)||0;
      const rate = Number(j.rate)||0;
      const isNS = j.rateType === "nsensor";

      totalHa += size;
      totalKg += total;

      // Determine RATE text
      const rateScreen = isNS ? 
        `N-Sensor` : 
        `${formatNum(rate)} <span class="unit">kg/ha</span>`;

      const ratePrint = isNS ?
        "N-Sensor" :
        `${formatNum(rate)} kg/ha`;

      // SCREEN ROW
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${j.date}</td>
        <td>${escapeHtml(j.field)}</td>
        <td>${escapeHtml(j.blend)}</td>
        <td>${rateScreen}</td>
        <td>${formatNum(size)} <span class="unit">ha</span></td>
        <td>${formatNum(total)} <span class="unit">kg</span></td>
        <td>
          <button class="btn-edit" data-id="${j.id}">Edit</button>
          <button class="btn-del" data-id="${j.id}" style="margin-left:8px">Delete</button>
        </td>`;
      screenBody.appendChild(tr);

      // PRINT ROW
      const pr = document.createElement('tr');
      pr.innerHTML = `
        <td>${escapeHtml(j.field)}</td>
        <td>${escapeHtml(j.blend)}</td>
        <td style="text-align:right">${ratePrint}</td>
        <td style="text-align:right">${formatNum(size)} ha</td>
        <td style="text-align:right">${formatNum(total)} kg</td>`;
      printBody.appendChild(pr);
    });

    totalsEl.textContent =
      `Totals: ${formatNum(totalHa,2)} ha → ${formatNum(totalKg,2)} kg`;
    printTotals.textContent =
      `Totals: ${formatNum(totalHa,2)} ha — ${formatNum(totalKg,2)} kg`;

    // delete
    document.querySelectorAll('.btn-del').forEach(btn=>{
      btn.onclick = function(){
        if(!confirm("Delete this job?")) return;
        window.FarmApp.deleteJobById(this.dataset.id);
        renderForDate(reportDateEl.value);
      };
    });

    // edit
    document.querySelectorAll('.btn-edit').forEach(btn=>{
      btn.onclick = function(){
        const jobs = window.FarmApp.loadJobs();
        const job = jobs.find(j=>j.id===this.dataset.id);
        if(!job) return;

        // Keep your existing edit system
        const nf = prompt("Field:", job.field); if(nf===null) return;
        const nb = prompt("Blend:", job.blend); if(nb===null) return;

        if(job.rateType === "nsensor"){
          const nt = prompt("Total KG:", job.total); if(nt===null) return;
          job.total = Number(nt)||0;
        } else {
          const nr = prompt("Rate (kg/ha):", job.rate); if(nr===null) return;
          const ns = prompt("Size (ha):", job.size); if(ns===null) return;
          job.rate = Number(nr)||0;
          job.size = Number(ns)||0;
          job.total = job.rate * job.size;
        }

        job.field = nf;
        job.blend = nb;

        window.FarmApp.updateJob(job);
        renderForDate(reportDateEl.value);
      };
    });
  }

  prevBtn.onclick = function(){
    const d = new Date(reportDateEl.value);
    d.setDate(d.getDate()-1);
    reportDateEl.value = d.toISOString().slice(0,10);
    renderForDate(reportDateEl.value);
  };

  nextBtn.onclick = function(){
    const d = new Date(reportDateEl.value);
    d.setDate(d.getDate()+1);
    reportDateEl.value = d.toISOString().slice(0,10);
    renderForDate(reportDateEl.value);
  };

  reportDateEl.onchange = ()=> renderForDate(reportDateEl.value);

  printBtn.onclick = ()=>{
    renderForDate(reportDateEl.value);
    setTimeout(()=>print(),150);
  };

  csvBtn.onclick = ()=>{
    const jobs = window.FarmApp.getJobsForDate(reportDateEl.value);
    let csv = "Date,Field,Blend,Rate,Size,Total\n";
    jobs.forEach(j=>{
      const r = j.rateType === "nsensor" ? "N-Sensor" : j.rate;
      csv += `${j.date},${j.field},${j.blend},${r},${j.size},${j.total}\n`;
    });
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "daily-report.csv";
    a.click();
  };

  renderForDate(reportDateEl.value);
})();
</script>
