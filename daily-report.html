<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Report</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Daily Report</h1>
      <div class="nav">
        <a href="index.html">Daily Work</a> |
        <a href="daily-report.html">Daily Report</a>
      </div>
    </header>

    <div class="card">
      <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:12px;flex-wrap:wrap">
        <button id="prevDay" class="btn">◀ Prev</button>
        <input id="reportDate" type="date" style="padding:8px;border-radius:8px;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.04)">
        <button id="nextDay" class="btn">Next ▶</button>

        <div style="width:16px"></div>

        <button id="printBtn" class="btn btn-print">Print</button>
        <button id="csvBtn" class="btn btn-csv">Export CSV</button>
      </div>

      <div class="table-wrap screen-table">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Field</th>
              <th>Blend</th>
              <th>Rate (kg/ha)</th>
              <th>Size (ha)</th>
              <th>Total (kg)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="screenBody"></tbody>
        </table>
      </div>

      <div id="totals" class="totals"></div>
    </div>

    <!-- print table (hidden on screen) -->
    <div class="print-table">
      <div class="print-wrapper">
        <div class="print-inner">
          <div style="text-align:center;margin-top:20px">
            <h2 style="margin:0">Daily Report</h2>
            <div style="font-weight:700;margin-top:4px">Report for: <span id="printDateLabel">—</span></div>
          </div>
          <table style="margin-top:14px">
            <thead class="print-head">
              <tr>
                <th>Field ID</th>
                <th>Fert Blend</th>
                <th>Rate (kg/ha)</th>
                <th>Field Size (ha)</th>
                <th>Total KG</th>
              </tr>
            </thead>
            <tbody id="printBody"></tbody>
          </table>
          <div style="margin-top:10px;font-weight:700" id="printTotals"></div>
        </div>
      </div>
    </div>

  </div>

<script src="app.js"></script>
<script>
(function(){
  const reportDateEl = document.getElementById('reportDate');
  const prevBtn = document.getElementById('prevDay');
  const nextBtn = document.getElementById('nextDay');
  const screenBody = document.getElementById('screenBody');
  const printBody = document.getElementById('printBody');
  const totalsEl = document.getElementById('totals');
  const printDateLabel = document.getElementById('printDateLabel');
  const printTotals = document.getElementById('printTotals');
  const printBtn = document.getElementById('printBtn');
  const csvBtn = document.getElementById('csvBtn');

  // set today as default
  function isoToday(){ return new Date().toISOString().slice(0,10); }
  reportDateEl.value = isoToday();

  // render for chosen date
  function renderForDate(isoDate){
    screenBody.innerHTML = '';
    printBody.innerHTML = '';
    printDateLabel.textContent = isoDate;

    const jobs = window.FarmApp.getJobsForDate(isoDate);
    if(!jobs.length){
      totalsEl.textContent = 'Totals: 0 ha → 0 kg';
      printTotals.textContent = '';
      return;
    }

    let totalHa = 0, totalKg = 0;

    jobs.forEach((j, idx)=>{
      const rate = Number(j.rate)||0;
      const size = Number(j.size)||0;
      const total = Number(j.total) || rate*size;
      totalHa += size;
      totalKg += total;

      // SCREEN row
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${j.date}</td>
        <td>${escapeHtml(j.field)}</td>
        <td>${escapeHtml(j.blend)}</td>
        <td>${formatNum(rate)} <span class="unit">kg/ha</span></td>
        <td>${formatNum(size)} <span class="unit">ha</span></td>
        <td>${formatNum(total)} <span class="unit">kg</span></td>
        <td>
          <button class="btn-edit" data-id="${j.id}">Edit</button>
          <button class="btn-del" data-id="${j.id}" style="margin-left:8px">Delete</button>
        </td>`;
      screenBody.appendChild(tr);

      // PRINT row
      const pr = document.createElement('tr');
      pr.innerHTML = `
        <td>${escapeHtml(j.field)}</td>
        <td>${escapeHtml(j.blend)}</td>
        <td style="text-align:right">${formatNum(rate)} kg/ha</td>
        <td style="text-align:right">${formatNum(size)} ha</td>
        <td style="text-align:right">${formatNum(total)} kg</td>`;
      printBody.appendChild(pr);
    });

    totalsEl.textContent = `Totals: ${formatNum(totalHa,2)} ha → ${formatNum(totalKg,2)} kg`;
    printTotals.textContent = `Totals: ${formatNum(totalHa,2)} ha — ${formatNum(totalKg,2)} kg`;

    // wire edit/delete
    Array.from(document.querySelectorAll('.btn-del')).forEach(b=>{
      b.onclick = function(){
        const id = this.dataset.id;
        if(!confirm('Delete this job?')) return;
        window.FarmApp.deleteJobById(id);
        renderForDate(reportDateEl.value);
      };
    });
    Array.from(document.querySelectorAll('.btn-edit')).forEach(b=>{
      b.onclick = function(){
        const id = this.dataset.id;
        const jobs = window.FarmApp.loadJobs();
        const job = jobs.find(x=>x.id===id);
        if(!job) return;
        const nf = prompt('Field:', job.field); if(nf===null) return;
        const nb = prompt('Blend:', job.blend); if(nb===null) return;
        const nr = prompt('Rate (kg/ha):', job.rate); if(nr===null) return;
        const ns = prompt('Size (ha):', job.size); if(ns===null) return;
        job.field = nf; job.blend = nb; job.rate = Number(nr)||0; job.size = Number(ns)||0;
        job.total = job.rate * job.size;
        window.FarmApp.updateJob(job);
        renderForDate(reportDateEl.value);
      };
    });
  }

  // helpers
  function formatNum(n,d=0){
    if(isNaN(n)) return n;
    return Number(n).toLocaleString(undefined,{minimumFractionDigits:d, maximumFractionDigits:d});
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

  // navigation
  prevBtn.onclick = function(){
    const dt = new Date(reportDateEl.value);
    dt.setDate(dt.getDate()-1);
    reportDateEl.value = dt.toISOString().slice(0,10);
    renderForDate(reportDateEl.value);
  };
  nextBtn.onclick = function(){
    const dt = new Date(reportDateEl.value);
    dt.setDate(dt.getDate()+1);
    reportDateEl.value = dt.toISOString().slice(0,10);
    renderForDate(reportDateEl.value);
  };

  reportDateEl.onchange = function(){ renderForDate(reportDateEl.value); };

  // print & csv
  printBtn.onclick = function(){
    // show print view then call print; ensure print table is up-to-date
    renderForDate(reportDateEl.value);
    setTimeout(()=> window.print(), 200);
  };
  csvBtn.onclick = function(){
    window.FarmApp.exportCsvForDate(reportDateEl.value);
  };

  // initial render
  renderForDate(reportDateEl.value);

})();
</script>
</body>
</html>
