<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily Report</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">
  <header>
    <h1>Daily Report</h1>
    <div class="nav">
      <a href="index.html">Daily Work</a> |
      <a href="daily-report.html">Daily Report</a>
    </div>
  </header>

  <div class="card">

    <!-- controls -->
    <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:12px;flex-wrap:wrap">
      <button id="prevDay" class="btn">◀ Prev</button>
      <input id="reportDate" type="date" class="date-input">
      <button id="nextDay" class="btn">Next ▶</button>

      <div style="width:16px"></div>

      <button id="printBtn" class="btn btn-print">Print</button>
      <button id="csvBtn" class="btn btn-csv">Export CSV</button>
    </div>

    <!-- SCREEN TABLE -->
    <div class="table-wrap screen-table">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Field</th>
            <th>Blend</th>
            <th>Rate</th>
            <th>Size (ha)</th>
            <th>Total (kg)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="screenBody"></tbody>
      </table>
    </div>

    <div id="totals" class="totals"></div>
  </div>

  <!-- PRINT TABLE -->
  <div class="print-table">
    <div class="print-wrapper">
      <div class="print-inner">
        <div style="text-align:center;margin-top:20px">
          <h2 style="margin:0">Daily Report</h2>
          <div style="font-weight:700;margin-top:4px">
            Report for: <span id="printDateLabel">—</span>
          </div>
        </div>

        <table style="margin-top:14px">
          <thead class="print-head">
            <tr>
              <th>Field ID</th>
              <th>Fert Blend</th>
              <th>Rate</th>
              <th>Field Size (ha)</th>
              <th>Total KG</th>
            </tr>
          </thead>
          <tbody id="printBody"></tbody>
        </table>

        <div id="printTotals" style="margin-top:10px;font-weight:700"></div>
      </div>
    </div>
  </div>

</div>

<!-- LOAD FarmApp FIRST -->
<script src="app.js"></script>

<script>
(function(){

  // elements
  const reportDateEl = document.getElementById("reportDate");
  const screenBody = document.getElementById("screenBody");
  const printBody  = document.getElementById("printBody");
  const totalsEl   = document.getElementById("totals");
  const printTotals= document.getElementById("printTotals");
  const printDateLabel = document.getElementById("printDateLabel");

  // helper
  function fmt(n){
    return isNaN(n) ? n : Number(n).toLocaleString();
  }
  function escape(s){
    return String(s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));
  }

  function isoToday(){ return new Date().toISOString().slice(0,10); }
  reportDateEl.value = isoToday();

  // RENDER FUNCTION ----------------------------------
  function renderForDate(d){

    screenBody.innerHTML = "";
    printBody.innerHTML  = "";
    printDateLabel.textContent = d;

    const jobs = FarmApp.getJobsForDate(d);

    if(!jobs.length){
      totalsEl.textContent = "Totals: 0 ha → 0 kg";
      printTotals.textContent = "";
      return;
    }

    let totalHa = 0;
    let totalKg = 0;

    jobs.forEach(job => {

      const rateText =
        job.rateType === "nsensor"
        ? "N-Sensor"
        : fmt(job.rate) + " kg/ha";

      totalHa += Number(job.size)||0;
      totalKg += Number(job.total)||0;

      // SCREEN ROW
      screenBody.innerHTML += `
        <tr>
          <td>${job.date}</td>
          <td>${escape(job.field)}</td>
          <td>${escape(job.blend)}</td>
          <td>${rateText}</td>
          <td>${fmt(job.size)} ha</td>
          <td>${fmt(job.total)} kg</td>
          <td>
            <button class="btn-edit" data-id="${job.id}">Edit</button>
            <button class="btn-del"  data-id="${job.id}" style="margin-left:6px">Delete</button>
          </td>
        </tr>`;

      // PRINT ROW
      printBody.innerHTML += `
        <tr>
          <td>${escape(job.field)}</td>
          <td>${escape(job.blend)}</td>
          <td>${rateText}</td>
          <td>${fmt(job.size)} ha</td>
          <td>${fmt(job.total)} kg</td>
        </tr>`;
    });

    totalsEl.textContent =
      `Totals: ${fmt(totalHa)} ha → ${fmt(totalKg)} kg`;

    printTotals.textContent =
      `Totals: ${fmt(totalHa)} ha — ${fmt(totalKg)} kg`;
  }

  // navigation
  prevDay.onclick = function(){
    const d = new Date(reportDateEl.value);
    d.setDate(d.getDate()-1);
    reportDateEl.value = d.toISOString().slice(0,10);
    renderForDate(reportDateEl.value);
  };

  // Enable EDIT + DELETE buttons
  document.addEventListener("click", function(e){
    
    // DELETE
    if (e.target.classList.contains("btn-del")) {
      const id = e.target.dataset.id;
      if (!confirm("Delete this job?")) return;
      FarmApp.deleteJobById(id);
      renderForDate(reportDateEl.value);
    }

    // EDIT
    if (e.target.classList.contains("btn-edit")) {
      const id = e.target.dataset.id;
      const jobs = FarmApp.loadJobs();
      const job = jobs.find(j => j.id === id);
      if (!job) return;

      const nf = prompt("Field:", job.field); if (nf === null) return;
      const nb = prompt("Blend:", job.blend); if (nb === null) return;

      // If N-Sensor, skip rate
      let nr = job.rate;
      if (job.rateType !== "nsensor") {
        nr = prompt("Rate (kg/ha):", job.rate);
        if (nr === null) return;
      }

      const ns = prompt("Size (ha):", job.size); if (ns === null) return;

      // Update job
      job.field = nf;
      job.blend = nb;
      job.size = Number(ns) || 0;

      if (job.rateType === "nsensor") {
        job.total = Number(prompt("Total KG:", job.total)) || 0;
        job.rate = 0;
      } else {
        job.rate = Number(nr) || 0;
        job.total = job.rate * job.size;
      }

      FarmApp.updateJob(job);
      renderForDate(reportDateEl.value);
    }

  });

  nextDay.onclick = function(){
    const d = new Date(reportDateEl.value);
    d.setDate(d.getDate()+1);
    reportDateEl.value = d.toISOString().slice(0,10);
    renderForDate(reportDateEl.value);
  };

  reportDateEl.onchange = () => renderForDate(reportDateEl.value);

  printBtn.onclick = () => {
    renderForDate(reportDateEl.value);
    setTimeout(()=>print(),200);
  };

  csvBtn.onclick = () =>
    FarmApp.exportCsvForDate(reportDateEl.value);

  // INITIAL DRAW
  renderForDate(reportDateEl.value);

})();
</script>

</body>
</html>
